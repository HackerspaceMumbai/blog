#!/bin/sh

# Fail fast on errors and treat unset variables as errors
set -eu

# Ensure pnpm is available (clear error if missing)
if ! command -v pnpm >/dev/null 2>&1; then
  echo "âŒ pnpm is not installed or not on PATH. Install pnpm: https://pnpm.io/installation"
  exit 1
fi
#

# Pre-commit hook to run blog image tests
# This ensures that blog image functionality is tested before each commit
#

echo "ğŸ” Running pre-commit checks..."
# Run blog image tests (critical for preventing regressions)
echo "ğŸ§ª Running blog image tests..."
if ! pnpm test:blog-images; then
    echo "âŒ Blog image tests failed. Please fix the issues before committing."
    echo "ğŸ’¡ Run 'pnpm test:blog-images' to see detailed test results."
    exit 1
fi

echo "âœ… Blog image tests passed!"

# Run visual regression tests (if not skipped and dev server is available)
if [ "${SKIP_VISUAL_TESTS:-0}" = "1" ]; then
    echo "âš ï¸  SKIP_VISUAL_TESTS=1 is set, skipping visual regression tests."
else
    echo "ğŸ“¸ Running deployment-friendly visual tests..."
    # Use curl HEAD request with short connect/read timeouts, no -f, treat any response as server up
    if curl -I --connect-timeout 2 --max-time 4 http://localhost:4321 >/dev/null 2>&1; then
        if ! pnpm test:visual:ci; then
            echo "âš ï¸  Visual tests had issues but not blocking deployment"
            echo "ğŸ’¡ Run 'pnpm test:visual:strict' for detailed analysis after deployment"
        else
            echo "âœ… Visual tests passed!"
        fi
    else
        echo "âš ï¸  Dev server not running or unreachable, skipping visual regression tests"
        echo "ğŸ’¡ Run 'pnpm dev' in another terminal for complete pre-commit testing"
    fi
fi

# Run other critical tests
echo "ğŸ§ª Running unit tests..."
if ! pnpm test; then
    echo "âŒ Unit tests failed. Please fix the issues before committing."
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit!"